var io = null;

var dispacher = {
	on: function() {}
}

exports.io = function(_io) {
	io = _io;

	return this;
}

exports.on = function(fn) {
	dispacher.on = fn;
}

exports.onConnect = function(socket) { 
	
  // (function() {
  //  // var emit = socket.emit;
  //  //  socket.emit = function() {
  //  //    console.log('***','emit', Array.prototype.slice.call(arguments));
  //  //    emit.apply(socket, arguments);
  //  //  };
  //   var $emit = socket.$emit;
  //   socket.$emit = function() {
  //     //console.log('***','on',Array.prototype.slice.call(arguments));
  //     //console.log(arguments[0]);
  //     dispacher.on(arguments[1], arguments[2], function() {}, function() {});
  //     $emit.apply(socket, arguments);
  //   };
  // })();

	socket.on('DATA_TO_SERVER', function (req, ack) {    
    //cb.ack('response');

    dispacher.on(req.event, req.data, ack, function(data) {     	
    	socket.emit('DATA_FROM_SERVER', { data:data }, req.ackId);
    });
  });

  socket.on('DATA_TO_CLIENT', function (req) {    
    io.sockets.socket(req.to).emit('REQUEST_FOR_CLIENT', { to:socket.id, event:req.event, data:req.data }, req.ackId);
  });

  socket.on('DATA_TO_CLIENTS', function (req) {    
    if(req.broadcast) {
       socket.broadcast.emit('REQUEST_FOR_CLIENTS', { event:req.event, data:req.data });
    } else {
      io.sockets.emit('REQUEST_FOR_CLIENTS', { event:req.event, data:req.data });
    }
  });

  socket.on('RESPONSE_FROM_CLIENT', function (req) {
    io.sockets.socket(req.to).emit('RESPONSE_TO_CLIENT', { data:req.data }, req.ackId);
  });

  socket.on('MESSAGE_TO_CLIENT', function (req) {        
    io.sockets.socket(req.to).send(req.message);
  });

  socket.on('MESSAGE_TO_CLIENTS', function (req) {
    if(req.broadcast) {
      socket.broadcast.send(req.message);
    } else {
      io.sockets.send(req.message);
    }
  });
}